/*
 spux-1.1.0.js
 Copyright (c) 2016 Rakuten.Inc
 Date: 2016-10-12 16:48:59
*/
Rmodules&&"function"==typeof Rmodules.define&&Rmodules.define(["jQuery","R^1","R.api^1"],function(a,b){function c(a){return-1!==b.find(C,function(b){return b===a})}function d(a){return-1!==b.find(D,function(b){return b===a})}function e(a){return a===b.enums.PointType.SD}function f(f,g){function h(a){var c,d,e,f;if(b.isString(a))for(a=a.split(";"),c=[],e=0,f=a.length;f>e;e++)d=a[e].split(":"),c.push({type:d[0],rate:parseFloat(d[1])});else c=a;return c}function i(a){var c,d,e,f,g;if(b.isString(a))for(a=a.split(";"),
c={},f=0,g=a.length;g>f;f++)d=a[f].split(":"),e=b.enums.UserRank[d[0]],c[e]=parseFloat(d[1]);else c=a;return c}function j(a,f){var j,k,l,m,n,o,p,q,r=g.totalRate,s=0,t=[],u={};if(!g)return void 0;for(a=a||0,f=f||{},j=g.getAllServices(!1),p=i(f.henbai),k=0,l=j.length;l>k;k++)m=j[k].service,n=B[m.id.toUpperCase()],t.push({type:n,rate:m.rate});if(f&&f.extraRate)for(o=h(f.extraRate),k=0,l=o.length;l>k;k++)m=o[k],q=m.rate,n=B[m.type.toUpperCase()],c(n)||t.push({type:n,rate:q}),d(n)||(n===b.enums.PointType.HEN&&p&&(q=(q||0)+parseFloat(p[g.userRank]||0)),
r+=q),e(n)&&(s+=q);return u.totalPoints=b.calculatePoints(a,t,{henbai:p,userRank:g.userRank,itemType:f.itemType}),u.totalRate=s?0:r,u.superDealRate=s,u}function k(c){var d,e,f,h,i,k,l,m,n,o,p=a.extend({},G.display,c),q=a(p.parent).find(p.sDisplayElements).not("."+p.cDisplayedElements);for(l=0,m=q.length;m>l;l++)d=q.eq(l),f=d.data(p.dataPrice),h=d.data(p.dataExtraRate),i=d.data(p.dataHenbai),k=d.data(p.dataItemType),n={extraRate:h,henbai:i,userRank:g.userRank,itemType:k},o=j(f,n),e={"#USER_RANK#":g.getUserRankString(),
"#TOTAL_RATE#":o.totalRate,"#ITEM_POINTS#":o.totalPoints,"#ITEM_POINTS_FORMATTED#":b.display.formatNumber(o.totalPoints),"#SUPER_DEAL_PERCENT#":o.superDealRate},e["#NZ_POINTS#"]=o.totalPoints>0?b.applyTemplate(p.templateNzPoints,e):"",e["#NZ_RATE#"]=o.totalRate>0?b.applyTemplate(p.templateNzRate,e):"",e["#NZ_SUPER_DEAL#"]=o.superDealRate>0?b.applyTemplate(p.templateNzSuperDeal,e):"",d.html(b.applyTemplate(p.template,e,!1)).addClass(p.cDisplayedElements);return q}var l={Cases:z,type:f,data:g,getInfo:j,
displayPoints:k};return G.display.enabled&&(G.display.onError||f!==z.ERROR)?(G.display.waitDom?a(k):k(),H.def.resolve(l)):H.def.reject(),a(G.css.sEventElem).trigger(G.global.componentEvent,l),H.def.promise()}function g(a){var c=b.find(z,function(b){return b===a});return b.isString(c)?c.toLowerCase():""}function h(a,b,c){function d(){var b,c,d,e=[];for(c=0,d=a.sections.length;d>c;c++)(b.totalRate>0||G.sc.includeUnusedSections)&&e.push(G.sc.formatSection.replace(/#SECTION_ID#/g,b.id).replace(/#SECTION_NAME#/g,b.name).replace(/#SECTION_TOTALRATE#/g,b.totalRate));
return e.join(G.sc.formatSectionSeparator)}function e(){var b,c,d,e,f,g,h=[];for(d=0,e=a.sections.length;e>d;d++)for(b=a.sections[d],f=0,g=b.services.length;g>f;f++)c=b.services[f],(c.isQualified||G.sc.includeUnusedServices)&&h.push(G.sc.formatService.replace(/#SERVICE_ID#/g,c.id).replace(/#SERVICE_NAME#/g,c.name).replace(/#SERVICE_RATE#/g,c.rate).replace(/#SERVICE_QUALIFIES#/g,c.isQualified?1:0));return h.join(G.sc.formatServiceSeparator)}var f="",h="";return a&&(-1!==b.indexOf("#SERVICES#")&&(h=e()),
-1!==b.indexOf("#SECTIONS#")&&(f=d())),b.replace(/#TOTALRATE#/g,a?a.totalRate:0).replace(/#USERRANK#/g,a?a.getUserRankString():"na").replace(/#SOURCE#/g,G.spu.source.toLowerCase()).replace(/#VIEWTYPE#/g,G.spu.viewType.toLowerCase()).replace(/#CASE#/g,g(c)).replace(/#SECTIONS#/g,f).replace(/#SERVICES#/g,h)}function i(a,b,c,d){var e={};return e[a]=h(b,c,d),e}function j(b,c){G.sc.enabled&&(a(document).ready(function(){window.SC&&"function"==typeof window.SC.sendScDataOnLoad&&(window.SC.sendScDataOnLoad(b),
c&&(window.location=c))}),c&&window.setTimeout(function(){window.location=c},G.catalyst.send_link_timeout))}function k(a,b,c,d){function e(){return G.spu.itemId?[G.spu.shopId||"",G.spu.itemId].join("/"):""}var f,g,i,j,k,l,m={accountId:G.rat.accountId,serviceId:G.rat.serviceId,options:["url","ua"],pData:{itemId:e(),pgn:G.spu.viewType,pgl:G.spu.source,abtest:h(a,c,b)},cpData:{}};if(d&&(m.eventType=d),a)for(m.cpData.total=a.totalRate,f=0,g=a.sections.length;g>f;f++)if(i=a.sections[f],i.totalRate>0||G.rat.includeUnusedSections)for(m.cpData["sec_"+i.id]=i.totalRate,
j=0,k=i.services.length;k>j;j++)l=i.services[j],(l.isQualified||G.rat.includeUnusedServices)&&(m.cpData["srv_"+l.id]=l.rate);return m}function l(c){G.rat.enabled&&a(document).ready(function(){window.RAT&&b.isFunction(window.RAT.addCustomEvent)&&window.RAT.addCustomEvent(c)})}function m(a,c){var d=c.split(",");return-1!==b.find(d,function(c){return z[b.trim(c).toUpperCase()]===a})}function n(b,c){var d=!0;a(G.css.sTrackingClick).on("hover"===G.popup.displayOn?"mouseover":"click",function(){d&&(d=!1,
G.sc.sendShowEnabled&&m(b,G.sc.sendShowOn)&&j(i(G.sc.sendShowProp,c,G.sc.sendShowFormat,b)),G.rat.sendShowEnabled&&m(b,G.rat.sendShowOn)&&l(k(c,b,G.rat.sendShowCaseName,"hover"===G.popup.displayOn?"mouseover":void 0)))})}function o(a,c){var d={showDelay:G.popup.showDelay,hideDelay:G.popup.hideDelay,checkDelay:G.popup.checkDelay};m(a,G.popup.enableOn)&&("click"===G.popup.displayOn?b.enableOnClick(F.iconContainer,F.popupContainer,F.popupCloseButton,d):"hover"===G.popup.displayOn&&b.enableOnHover(F.iconContainer,F.popupContainer,d));
}function p(a){var b,c,d=G.css,e={};e[z.NOT_LOGGED]=d.sCaseNologin,e[z.NONE]=d.sCase1,e[z.NORMAL]=d.sCaseN,e[z.ERROR]=d.sCaseError,e[z.SUPER_DEAL]=d.sCaseSuperdeal,e[z.DISABLED]=d.sCaseDisabled,c="."+e[a].substring(1);for(b in F.templates)F.templates[b].not(c).remove()}function q(a,c){var d,e,f,g,h,i,j,k,l,m,n,o;if(c){for(n=G.global.disabledSections.split(","),j=0,k=n.length;k>j;j++)n[j]=b.trim(n[j]);for(o=G.global.disabledServices.split(","),j=0,k=o.length;k>j;j++)o[j]=b.trim(o[j]);for(d=F.templates[a],
j=0,k=d.length;k>j;j++)if(e=d.eq(j),f=e.find("."+G.css.cTemplateSection),f.length>0){for(g=f[0].outerHTML,l=0,m=c.sections.length;m>l;l++)i=c.sections[l],-1===n.indexOf(i.id)&&(G.global.showEmptySections||i.services.length>0)&&(h=r(g,i,o),(G.global.showEmptySections||h.nServices>0)&&f.before(h.$section));f.remove()}F.totalRate.html(c.totalRate)}}function r(c,d,e){var f,g,h,i,j,k,l={"#SECTION_ID#":d.id,"#SECTION_NAME#":b.truncate(d.name,G.global.sectionNameMaxLength),"#SECTION_FULLNAME#":d.name,"#SECTION_TOTALRATE#":d.totalRate
},m={$section:a(b.applyTemplate(c,l,!1)).removeClass(G.css.cTemplateSection),nServices:0};if(h=m.$section.find("."+G.css.cTemplateService),h.length>0){for(i=h[0].outerHTML,j=0,k=d.services.length;k>j;j++)g=d.services[j],-1===e.indexOf(g.id)&&(G.global.showEmptyServices||g.rate>0)&&(f=s(i,g),h.before(f),m.nServices++);h.remove()}return m}function s(c,d){var e,f={"#SERVICE_ID#":d.id,"#SERVICE_NAME#":b.truncate(d.name,G.global.serviceNameMaxLength),"#SERVICE_FULLNAME#":d.name,"#SERVICE_RATE#":d.rate,
"#SERVICE_LINK#":b.getTrackingLinks(d.link,G.sc),"#SERVICE_DISCLAIMER#":d.disclaimer||""};e=a(b.applyTemplate(c,f,!1)).removeClass(G.css.cTemplateService);var g,h,i,j,k,l=e.find("a");for(g=0,h=l.length;h>g;g++)j=a(l[g]),i=j.attr("href"),k=i.indexOf("http://",4),-1!==k&&j.attr("href",i.substring(k));return d.isQualified&&e.addClass(G.css.cServiceQualifies),d.link||e.find(G.css.sServiceLink).remove(),e}function t(a,b){var c,d,e,f,g,h;for(a.addClass(G.css.cTotalRate.replace(/#TOTAL_RATE#/g,b.totalRate)).addClass(G.css.cUserRank.replace(/#USER_RANK#/g,b.getUserRankString())),
c=0,e=b.sections.length;e>c;c++)for(d=b.sections[c],f=0,h=d.services.length;h>f;f++)g=d.services[f],g.isQualified&&a.addClass(G.css.cQualifiesService.replace(/#SERVICE_ID#/g,g.id))}function u(c){function d(a,b){var c,d;if(b.hasClass(G.css.cTogglerHidden)){for(c=0,d=o.length;d>c;c++)o.eq(c).addClass(G.css.cTogglerHidden);n.addClass(G.css.cTogglerHidden),a.removeClass(G.css.cTogglerHidden),b.removeClass(G.css.cTogglerHidden)}else a.addClass(G.css.cTogglerHidden),b.addClass(G.css.cTogglerHidden)}function e(a,b){
return function(){a.toggleClass(G.css.cTogglerHidden),b.toggleClass(G.css.cTogglerHidden)}}function f(a,b){return function(){d(a,b)}}var g,h,i,j,k,l,m,n=c.find(G.css.sSectionToggler),o=a();for(k=0,l=n.length;l>k;k++)g=n.eq(k),j=g.data("toggle"),j&&(h=c.find(j),o=o.add(h),"toggle"===G.popup.toggleType?g.click(e(g,h)):"accordion"===G.popup.toggleType&&g.click(f(g,h)));if("ALL"!==G.popup.toggleShow.toUpperCase())for(n.addClass(G.css.cTogglerHidden),o.addClass(G.css.cTogglerHidden),i=G.popup.toggleShow.split(","),
k=0,l=i.length;l>k;k++)b.isNumeric(i[k])?(m=parseInt(i[k],10)-1,n.eq(m).removeClass(G.css.cTogglerHidden),o.eq(m).removeClass(G.css.cTogglerHidden)):(o.filter('[data-toggle="'+i[k]+'"]').removeClass(G.css.cTogglerHidden),o.filter(i[k]).removeClass(G.css.cTogglerHidden))}function v(a){function b(a,b,c){var d=c.indexOf(a.id),e=c.indexOf(b.id);return-1===d&&(d=99999),-1===e&&(e=99999),d-e}function c(a,c){return b(a,c,g)}function d(a,c){return b(a,c,h)}var e,f,g=G.global.orderSections,h=G.global.orderServices;
if(g&&a.sections.sort(c),h)for(e=0,f=a.sections.length;f>e;e++)a.sections[e].services.sort(d)}function w(a,b){var c,d=F.iconContainer.add(F.popupContainer);p(a),v(b),q(a,b),F.icon.children().appendTo(F.iconContainer),F.popup.children().appendTo(F.popupContainer),b&&t(d,b),o(a,b),u(F.popupContainer),n(a,b),c=f(a,b),d.data(G.global.componentData,c),d.addClass(G.css.cReady),G.sc.sendDataEnabled&&j(i(G.sc.sendDataProp,b,G.sc.sendDataFormat,a)),G.rat.sendDataEnabled&&l(k(b,a,G.rat.sendDataCaseName))}function x(){
function b(a,b){var c,d;if(a){for(c in b)d=G.global.globalReplacement.replace("%",c.toUpperCase()),a=a.replace(new RegExp(d,"g"),b[c]);return a}}function c(b){var c,d,e;for(d=0,e=b.length;e>d;d++)c=a.extend(c,b.eq(d).data());return c||{}}var d,e,f,g=G.css,h={NOT_LOGGED:g.sCaseNologin,NONE:g.sCase1,NORMAL:g.sCaseN,ERROR:g.sCaseError,SUPER_DEAL:g.sCaseSuperdeal,DISABLED:g.sCaseDisabled},i=a(g.sIcon).last(),j=a(g.sPopup).last(),k=i.find('script[type="text/template"]'),l=j.find('script[type="text/template"]'),m=k.last().html(),n=l.last().html();
m=b(m,c(F.settings.find(E.config.templateIconData))),n=b(n,c(F.settings.find(E.config.templatePopupData))),d=a("<div>").append(m),e=a("<div>").append(n),k.remove(),l.remove(),F.iconContainer=i,F.popupContainer=j,F.icon=d,F.popup=e,F.totalRate=d.find(g.sTotalRate).add(e.find(g.sTotalRate)),F.popupCloseButton=d.find(g.s_popup_close_button).add(e.find(g.sPopupCloseButton)),F.templates={};for(f in h)F.templates[z[f]]=F.icon.find(h[f]).add(F.popup.find(h[f]));return F.icon.length&&F.iconContainer.length||F.popup.length&&F.popupContainer.length;
}function y(){if(G&&x())if(G.global.useTemplate)w(G.global.useTemplate);else if(b.user.isLogged(G.global.userLogged)){var c=a('[name="head"]').attr("name",null);b.api.spu.loadSpu(a.extend({},G.spu,{encoding:G.spu.encoding,sid:G.spu.sid,source:G.spu.source,viewType:G.spu.viewType,userRank:G.spu.userRank,itemId:G.spu.itemId,shopId:G.spu.shopId})).done(function(a){w(1===a.totalRate?z.NONE:z.NORMAL,a)}).fail(function(){w(z.ERROR)}),c.attr("name","head")}else w(z.NOT_LOGGED,G.spu.defaultOnNotLogged?A:null);
}var z={NOT_LOGGED:1,NONE:2,NORMAL:3,ERROR:4,SUPER_DEAL:5,DISABLED:6},A=new b.api.spu.ResponseData({userRank:b.api.spu.UserRank.DEFAULT,totalRate:1,sections:[{id:"spuBasePoint",name:"\u30d9\u30fc\u30b9\u30dd\u30a4\u30f3\u30c8\u5408\u8a08",totalRate:1,services:[{id:"normal",name:"\u901a\u5e38\u8cfc\u5165\u5206",rate:"1",qualified:!0},{id:"rakutenCard",name:"\u697d\u5929\u30ab\u30fc\u30c9\u3054\u5229\u7528",rate:"3",qualified:!1},{id:"mobileApp",name:"\u30a2\u30d7\u30ea\u304b\u3089\u5f53\u67081\u56de\u4ee5\u4e0a\u3054\u8cfc\u5165",
rate:"1",qualified:!1},{id:"rakutenPremiumCard",name:"\u697d\u5929\u30d7\u30ec\u30df\u30a2\u30e0\u30ab\u30fc\u30c9\u30fb\u697d\u5929\u30b4\u30fc\u30eb\u30c9\u30ab\u30fc\u30c9\u3054\u5229\u7528",rate:"1",qualified:!1,link:"//ad2.trafficgate.net/t/r/9062/1441/99636_99636/"},{id:"rakutenMobile",name:"\u697d\u5929\u30e2\u30d0\u30a4\u30eb\u3054\u52a0\u5165",rate:"1",qualified:!1}]}]}),B={NORMAL:b.enums.PointType.BASE,RAKUTENMOBILE:b.enums.PointType.MB,RAKUTENCARD:b.enums.PointType.CB,RAKUTENPREMIUMCARD:b.enums.PointType.CB,
MOBILEAPP:b.enums.PointType.APP,SUPERDEAL:b.enums.PointType.SD,DPG:b.enums.PointType.DPG,HENBAI:b.enums.PointType.HEN,KAIMAWARI:b.enums.PointType.KAI,SHOPPOINT:b.enums.PointType.SHOP,ITEMPOINT:b.enums.PointType.ITEM,RAKUTENKOBO:b.enums.PointType.KOBO,TOOLBAR:b.enums.PointType.TBAR},C=[b.enums.PointType.KAI,b.enums.PointType.DPG],D=[b.enums.PointType.SD],E={config:{settingsContainer:".spux-settings",settingsGlobal:".spux-settings-global",settingsCss:".spux-settings-css",settingsSc:".spux-settings-sc",
settingsRat:".spux-settings-rat",settingsSpu:".spux-settings-spu",settingsPopup:".spux-settings-popup",settingsDisplay:".spux-settings-display",templateIconData:".spux-template-icon-data",templatePopupData:".spux-template-popup-data"},global:{enabled:[!0,"bool"],waitDom:[!1,"bool"],useTemplate:[void 0,"enumValue",z],sectionNameMaxLength:[64,"int"],serviceNameMaxLength:[64,"int"],disabledSections:["","str"],disabledServices:["","str"],orderSections:["","str"],orderServices:["","str"],userLogged:[void 0,"bool"],
showEmptySections:[!1,"bool"],showEmptyServices:[!1,"bool"],componentData:["spux","str"],componentEvent:["spux-data-ready","str"],globalReplacement:["{{%}}","str"]},css:{sEventElem:[".spux-icon-container,.spux-popup-container","str"],sIcon:[".spux-icon-container","str"],sPopup:[".spux-popup-container","str"],sPopupCloseButton:[".spux-popup-close-button","str"],sCase1:[".spux-case-one","str"],sCaseN:[".spux-case-n","str"],sCaseError:[".spux-case-error","str"],sCaseSuperdeal:[".spux-case-superdeal","str"],
sCaseNologin:[".spux-case-nologin","str"],sCaseDisabled:[".spux-case-disabled","str"],sTotalRate:[".spux-total-rate","str"],cTemplateSection:["spux-section-template","str"],cTemplateService:["spux-service-template","str"],sServiceLink:[".spux-service-link-icon","str"],sSectionToggler:[".spux-section-header .spux-popup-arrow","str"],cTogglerHidden:["toggler-hidden","str"],sTrackingClick:[".spux-icon-container","str"],cReady:["spux-ready","str"],cTotalRate:["spux-totalrate-#TOTAL_RATE#"],cUserRank:["spux-user-rank-#USER_RANK#","str"],
cQualifiesService:["spux-user-qualifies-#SERVICE_ID#","str"],cServiceId:["spux-service-id-#SERVICE_ID#","str"],cServiceQualifies:["spux-service-qualifies","str"]},sc:{enabled:[!0,"bool"],addTrackingLink:[!0,"bool"],sid:["","str"],lid:["","str"],l2id:["","str"],sendDataEnabled:[!0,"bool"],sendDataProp:["prop16","str"],sendDataFormat:["spux_data:#VIEWTYPE#:#SOURCE#:#CASE#:#TOTALRATE#:#SERVICES#","str"],sendShowEnabled:[!0,"bool"],sendShowOn:[void 0,"str"],sendShowProp:["prop18","str"],sendShowFormat:["spux_show:#VIEWTYPE#:#SOURCE#:#CASE#:#TOTALRATE#:#SERVICES#","str"],
includeUnusedSections:[!1,"bool"],includeUnusedServices:[!1,"bool"],formatSection:["#SECTION_ID#-#SECTION_TOTALRATE#","str"],formatSectionSeparator:[";","str"],formatService:["#SERVICE_ID#-#SERVICE_RATE#","str"],formatServiceSeparator:[";","str"],sendLinkTimeout:[3e3,"int"]},rat:{enabled:[!0,"bool"],accountId:[459,"int"],serviceId:[1,"int"],sendDataEnabled:[!0,"bool"],sendDataCaseName:["spux_data:#VIEWTYPE#:#SOURCE#:#CASE#","str"],sendShowEnabled:[!0,"bool"],sendShowOn:[void 0,"str"],sendShowCaseName:["spux_show:#VIEWTYPE#:#SOURCE#:#CASE#","str"],
includeUnusedSections:[!0,"bool"],includeUnusedServices:[!1,"bool"]},spu:{sid:[void 0,"enumValue",b.api.spu.ServiceId],source:[void 0,"enumValue",b.api.spu.Source],viewType:[void 0,"enumValue",b.api.spu.ViewType],userRank:[void 0,"enumValue",b.api.spu.UserRank],itemId:[void 0,"str"],shopId:[void 0,"str"],encoding:[b.api.spu.Encoding.EUC_JP,"enumValue",b.api.spu.Encoding],defaultOnNotLogged:[!0,"bool"]},popup:{enableOn:["NORMAL","str"],displayOn:[b.browser.isMobile?"click":"hover","str"],showDelay:[0,"int"],
hideDelay:[0,"int"],checkDelay:[300,"int"],toggleType:["toggle","str"],toggleShow:["all","str"]},display:{enabled:[!0,"bool"],waitDom:[!1,"bool"],parent:["body","str"],template:["<span>#ITEM_POINTS_FORMATTED#</span>","str"],templateNzPoints:["#ITEM_POINTS_FORMATTED#","str"],templateNzRate:["#TOTAL_RATE#","str"],templateNzSuperDeal:["#SUPER_DEAL_PERCENT#","str"],dataPrice:["price","str"],dataExtraRate:["extraRate","str"],dataHenbai:["henbai","str"],dataItemType:["itemType","str"],sDisplayElements:[".spux-display-formatted","str"],
cDisplayedElements:["spux-display-formatted-ready","str"]}},F={},G=function(){var c,d=a(E.config.settingsContainer).last();return 0===d.length?null:(F.settings=d,c={global:b.readSettings(d.find(E.config.settingsGlobal),E.global),css:b.readSettings(d.find(E.config.settingsCss),E.css),sc:b.readSettings(d.find(E.config.settingsSc),E.sc),rat:b.readSettings(d.find(E.config.settingsRat),E.rat),spu:b.readApiSettings(d.find(E.config.settingsSpu),E.spu),popup:b.readSettings(d.find(E.config.settingsPopup),E.popup),
display:b.readSettings(d.find(E.config.settingsDisplay),E.display)},void 0===c.sc.sendShowOn&&(c.sc.sendShowOn=c.popup.enableOn),void 0===c.rat.sendShowOn&&(c.rat.sendShowOn=c.popup.enableOn),c)}(),H={def:a.Deferred(),data:null};G.global.enabled&&b.browser.isSupported("2016-10-12")&&(G.global.waitDom?a(y):y())});
